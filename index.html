<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RelianceDesk â€” Seguros Vehiculares</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- LibrerÃ­as externas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- MSAL incluido localmente para mÃ¡xima compatibilidad -->
<script src="msal-browser.min.js"></script>

<!-- Estilos CRM -->
<link rel="stylesheet" href="crm.css">

<style>
/* Loader y Setup */
#sp-loader { position:fixed;inset:0;background:#fafaf7;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px }
.sp-spinner { width:36px;height:36px;border:3px solid #e8e2d6;border-top-color:#c94a2a;border-radius:50%;animation:sp-spin .8s linear infinite }
@keyframes sp-spin { to { transform:rotate(360deg) } }
#sp-setup { display:none;position:fixed;inset:0;background:#fafaf7;align-items:center;justify-content:center;z-index:9998 }
.setup-card { background:#fff;border:1px solid #e8e2d6;border-radius:16px;padding:40px;max-width:480px;width:90%;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.08) }
.setup-card h2 { font-family:'DM Serif Display',serif;font-size:24px;margin-bottom:8px }
.setup-card p { color:#888;font-size:13px;margin-bottom:24px;line-height:1.6 }
.setup-steps { text-align:left;margin-bottom:24px;display:flex;flex-direction:column;gap:8px }
.setup-step { display:flex;align-items:center;gap:10px;font-size:13px;padding:8px 12px;border-radius:8px;background:#f5f0e8 }
.setup-step.done { background:#d4edda;color:#2d6a4f }
.setup-step.active { background:#e8f0fb;color:#1a4c84 }
.setup-step.error { background:#fde8e0;color:#b71c1c }
.sp-status { display:flex;align-items:center;gap:6px;font-size:11px;padding:4px 10px;border-radius:20px;background:#f5f0e8;color:#888 }
.sp-status.online { background:#d4edda;color:#2d6a4f }
.sp-status.syncing { background:#fff3e0;color:#e65100 }
.sp-status.error { background:#fde8e0;color:#b71c1c }
</style>


<!-- LOADER -->
<div id="sp-loader">
  <div style="font-family:'DM Serif Display',serif;font-size:28px;color:#c94a2a">RELIANCE</div>
  <div class="sp-spinner"></div>
  <div id="sp-loader-msg" style="font-size:13px;color:#888">Conectando con Microsoft...</div>
</div>

<!-- SETUP / LOGIN -->
<div id="sp-setup"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN (fuera de .app para que sea visible independientemente)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="login-screen" id="login-screen" style="display:none">
  <div class="login-bg-text">RELIANCE</div>
  <div class="login-box">
    <div class="login-logo">RELIANCE</div>
    <div class="login-sub">RelianceDesk â€” Seguros Vehiculares</div>
    <label class="login-label">Usuario</label>
    <input class="login-input" id="login-user" placeholder="usuario@reliance.ec" onkeydown="if(event.key==='Enter')doLogin()">
    <label class="login-label">ContraseÃ±a</label>
    <input class="login-input" type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">Ingresar al Sistema</button>
    <div class="login-err" id="login-err"></div>
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);font-size:11px;color:var(--muted);text-align:center">
      ğŸ”’ Acceso restringido Â· Solo personal autorizado<br>
      <span style="opacity:.6">PrÃ³ximamente: login con cuenta @reliance.ec</span>
    </div>
  </div>
</div>

<!-- APP (oculta hasta que SP cargue) -->
<div class="app" style="display:none">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">RELIANCE</div>
    <div class="logo-sub">Asesores de Seguros</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">Principal</div>
    <div class="nav-item active" onclick="showPage('dashboard')"><span class="icon">â—ˆ</span><span>Dashboard</span></div>
    <div class="nav-item" onclick="showPage('clientes')"><span class="icon">â—‰</span><span>Clientes / Vencimientos</span><span class="nav-badge" id="badge-clientes">â€”</span></div>
    <div class="nav-item" onclick="showPage('calendario')"><span class="icon">ğŸ“…</span><span>Calendario</span><span class="nav-badge" id="badge-tareas" style="display:none"></span></div>
    <div class="nav-item" onclick="showPage('seguimiento')"><span class="icon">â—</span><span>Seguimiento</span></div>
    <div class="nav-item" onclick="showPage('cierres')"><span class="icon">âœ“</span><span>Cierres de Venta</span><span class="nav-badge" style="background:var(--green)" id="badge-cierres">0</span></div>
    <div class="nav-section">Herramientas</div>
    <div class="nav-item" onclick="showPage('cotizaciones')"><span class="icon">ğŸ“‹</span><span>Cotizaciones</span><span class="nav-badge" style="background:var(--accent2)" id="badge-cotizaciones">0</span></div>
    <div class="nav-item" onclick="showPage('cotizador')"><span class="icon">â—†</span><span>Cotizador</span></div>
    <div class="nav-item" onclick="showPage('comparativo')"><span class="icon">â—‡</span><span>Comparativo</span></div>
    <div class="nav-item" onclick="showPage('tasas')"><span class="icon">%</span><span>Tasas</span></div>
    <div class="nav-section admin-only" id="nav-admin-section">Admin</div>
    <div class="nav-item admin-only" id="nav-admin" onclick="showPage('admin')"><span class="icon">âš™</span><span>Panel Admin</span></div>
    <div class="nav-item admin-only" onclick="showPage('reportes')"><span class="icon">ğŸ“Š</span><span>Reportes</span></div>
    <div class="nav-item" onclick="showPage('nuevo-cliente')"><span class="icon">âŠ•</span><span>Nuevo Cliente</span></div>
  </nav>
  <div class="sidebar-footer">
    <div class="agent-card">
      <div class="agent-avatar" id="sidebar-avatar">â€”</div>
      <div>
        <div class="agent-name" id="sidebar-name">â€”</div>
        <div class="agent-role" id="sidebar-role">â€”</div>
      </div>
    </div>
    <button class="logout-btn" onclick="doLogout()">â†© Cerrar sesiÃ³n</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="page-title">Dashboard</div>
    <div class="topbar-actions">
      <span class="text-muted mono" style="font-size:11px" id="current-date"></span>
      <button class="btn btn-secondary btn-sm no-print" onclick="showPage('cotizador')">ğŸ§® Cotizar</button>
      <button class="btn btn-primary no-print" onclick="showPage('nuevo-cliente')">+ Nuevo Cliente</button>
    </div>
  </div>

  <!-- â•â• DASHBOARD â•â• -->
  <div class="page active" id="page-dashboard">
    <div class="stats-grid">
      <div class="stat-card s1"><div class="stat-icon">â—‰</div><div class="stat-label">Mi Cartera</div><div class="stat-value" id="stat-total">â€”</div><div class="stat-sub" id="stat-mes">Cargandoâ€¦</div></div>
      <div class="stat-card s2"><div class="stat-icon">â—†</div><div class="stat-label">Renovaciones</div><div class="stat-value" id="stat-renov">â€”</div><div class="stat-sub">Este mes</div></div>
      <div class="stat-card s3"><div class="stat-icon">â—ˆ</div><div class="stat-label">Nuevos</div><div class="stat-value" id="stat-nuevo">â€”</div><div class="stat-sub">PÃ³lizas emitidas</div></div>
      <div class="stat-card s5"><div class="stat-icon">â°</div><div class="stat-label">Vencen en 30 dÃ­as</div><div class="stat-value text-accent" id="stat-venc30">â€”</div><div class="stat-sub">Requieren acciÃ³n</div></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><div class="card-title">PrÃ³ximos Vencimientos</div><button class="btn btn-ghost btn-sm" onclick="showPage('clientes');setTimeout(()=>switchClienteTab('vencimientos'),50)">Ver todos â†’</button></div>
        <div class="card-body" style="padding:12px" id="dash-vencimientos"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Estado de Seguimiento</div></div>
        <div class="card-body" id="dash-seguimiento"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ“Œ Tareas de hoy</div>
          <button class="btn btn-ghost btn-sm" onclick="nuevaTarea()">+ Nueva</button>
        </div>
        <div class="card-body" style="padding:12px" id="dash-tareas"></div>
      </div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><div class="card-title">DistribuciÃ³n por Aseguradora</div></div>
        <div class="card-body" style="padding:12px"><table style="width:100%"><thead><tr><th style="text-align:left;padding:6px 10px;font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase">Aseguradora</th><th style="text-align:right;padding:6px 10px;font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase">Clientes</th><th style="padding:6px 10px;font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase">%</th></tr></thead><tbody id="aseg-dist-table"></tbody></table></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Actividad Reciente</div></div>
        <div class="card-body"><div class="timeline" id="activity-feed"></div></div>
      </div>
    </div>
  </div>

    <!-- TAREAS DEL DÃA en dashboard -->

<!-- â•â• CLIENTES â•â• -->
  <div class="page" id="page-clientes">

    <!-- TABS -->
    <div style="display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:16px">
      <button id="tab-cartera" onclick="switchClienteTab('cartera')"
        style="padding:10px 22px;border:none;background:none;font-size:13px;font-weight:600;
               color:var(--accent);border-bottom:2px solid var(--accent);margin-bottom:-2px;cursor:pointer">
        â—‰ Cartera
      </button>
      <button id="tab-vencimientos" onclick="switchClienteTab('vencimientos')"
        style="padding:10px 22px;border:none;background:none;font-size:13px;font-weight:600;
               color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer">
        â° Vencimientos <span class="nav-badge orange" id="badge-venc" style="position:relative;top:-1px">â€”</span>
      </button>
    </div>

    <!-- TAB CARTERA -->
    <div id="subtab-cartera">
      <div class="search-bar">
        <div class="search-wrap"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" placeholder="Buscar nombre, CI, placa, aseguradoraâ€¦" id="search-clientes" oninput="filterClientes()"></div>
        <select class="form-select" id="filter-tipo" onchange="filterClientes()" style="width:130px"><option value="">Todos los tipos</option><option value="NUEVO">Nuevos</option><option value="RENOVACION">Renovaciones</option></select>
        <select class="form-select" id="filter-aseg" onchange="filterClientes()" style="width:170px"><option value="">Todas las aseg.</option></select>
        <select class="form-select" id="filter-region" onchange="filterClientes()" style="width:110px"><option value="">RegiÃ³n</option><option value="SIERRA">Sierra</option><option value="COSTA">Costa</option></select>
        <select class="form-select" id="filter-estado" onchange="filterClientes()" style="width:170px"><option value="">Todos los estados</option><option value="PENDIENTE">âšª Pendiente</option><option value="INSPECCIÃ“N">ğŸ” InspecciÃ³n</option><option value="EMISIÃ“N">ğŸ“ EmisiÃ³n</option><option value="EMITIDO">ğŸ“„ Emitido</option><option value="RENOVADO">âœ… Renovado</option><option value="PÃ“LIZA VIGENTE">ğŸ›¡ PÃ³liza Vigente</option><option value="CRÃ‰DITO VENCIDO">â° CrÃ©dito Vencido</option><option value="CRÃ‰DITO CANCELADO">ğŸ’³ CrÃ©dito Cancelado</option><option value="SINIESTRO">ğŸš¨ Siniestro</option><option value="PÃ‰RDIDA TOTAL">ğŸš— PÃ©rdida Total</option><option value="PÃ“LIZA ANULADA">âŒ PÃ³liza Anulada</option><option value="ENDOSO">ğŸ“‹ Endoso</option><option value="NO RENOVADO">ğŸš« No Renovado</option><option value="INUBICABLE">ğŸ“µ Inubicable</option><option value="NO ASEGURABLE">â›” No Asegurable</option><option value="AUTO VENDIDO">ğŸ”‘ Auto Vendido</option><option value="CLIENTE FALLECIDO">ğŸ•Š Cliente Fallecido</option></select>
        <button class="btn btn-green btn-sm" onclick="exportToExcel()">â¬‡ Excel</button>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Cartera de Clientes</div><span class="text-muted" style="font-size:12px" id="clientes-count">â€” clientes</span></div>
        <div class="tbl-wrap">
          <table>
            <thead><tr><th>Cliente</th><th>CI</th><th>Tipo</th><th>Aseguradora</th><th>VehÃ­culo</th><th>Placa</th><th>Vence</th><th>DÃ­as</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="clientes-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB VENCIMIENTOS -->
    <div id="subtab-vencimientos" style="display:none">
      <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px">
        <div class="stat-card s6"><div class="stat-label">Vencidas</div><div class="stat-value" id="vstat-0">â€”</div><div class="stat-sub">Ya vencieron</div></div>
        <div class="stat-card s6"><div class="stat-label">CrÃ­tico â€” 30 dÃ­as</div><div class="stat-value" id="vstat-30">â€”</div><div class="stat-sub">AcciÃ³n inmediata</div></div>
        <div class="stat-card s5"><div class="stat-label">PrÃ³ximo â€” 60 dÃ­as</div><div class="stat-value" id="vstat-60">â€”</div><div class="stat-sub">Contactar pronto</div></div>
        <div class="stat-card s4"><div class="stat-label">En Cartera â€” 90 dÃ­as</div><div class="stat-value" id="vstat-90">â€”</div><div class="stat-sub">En seguimiento</div></div>
      </div>
      <div class="filter-pills" id="venc-pills">
        <div class="pill active" onclick="filterVencimientos('all',this)">Todos</div>
        <div class="pill" onclick="filterVencimientos('vencida',this)">ğŸ”´ Vencidas</div>
        <div class="pill" onclick="filterVencimientos('30',this)">ğŸ”´ 0â€“30 dÃ­as</div>
        <div class="pill" onclick="filterVencimientos('60',this)">ğŸŸ  31â€“60 dÃ­as</div>
        <div class="pill" onclick="filterVencimientos('90',this)">ğŸŸ¡ 61â€“90 dÃ­as</div>
      </div>
      <div id="vencimientos-list"></div>
    </div>

  </div>

  <!-- â•â• CALENDARIO â•â• -->
  <div class="page" id="page-calendario">
    <div class="card">
      <div class="card-header">
        <div class="cal-header" style="flex:1;margin:0">
          <button class="btn btn-ghost btn-sm" onclick="calNav(-1)">â† Anterior</button>
          <div class="cal-month" id="cal-month-title">â€”</div>
          <button class="btn btn-ghost btn-sm" onclick="calNav(1)">Siguiente â†’</button>
        </div>
        <div style="display:flex;gap:8px;margin-left:16px;align-items:center">
          <span style="font-size:11px;display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#fde8e0;border-radius:2px;display:inline-block;border:1px solid var(--accent)"></span>CrÃ­tico</span>
          <span style="font-size:11px;display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#fff3e0;border-radius:2px;display:inline-block;border:1px solid var(--orange)"></span>PrÃ³ximo</span>
          <span style="font-size:11px;display:flex;align-items:center;gap:4px"><span style="width:10px;height:10px;background:#fef3cd;border-radius:2px;display:inline-block;border:1px solid var(--gold)"></span>En cartera</span>
        </div>
      </div>
      <div class="card-body">
        <div class="cal-grid" id="cal-headers"></div>
        <div class="cal-grid" id="cal-body" style="margin-top:4px"></div>
      </div>
    </div>
    <!-- Panel tareas pendientes -->
    <div class="card" style="margin-top:16px">
      <div class="card-header">
        <div class="card-title">ğŸ“Œ Tareas pendientes</div>
        <button class="btn btn-primary btn-sm" onclick="nuevaTarea()">+ Nueva tarea</button>
      </div>
      <div class="card-body" style="padding:12px" id="cal-tareas-lista"></div>
    </div>
  </div>

  <!-- â•â• SEGUIMIENTO â•â• -->
  <div class="page" id="page-seguimiento">
    <div class="search-bar">
      <div class="search-wrap"><span class="search-icon">ğŸ”</span><input type="text" class="search-input" placeholder="Buscar clienteâ€¦" id="search-seg" oninput="filterSeguimiento()"></div>
      <div class="filter-pills" style="margin:0">
        <div class="pill active" onclick="filterSegEstado('',this)">Todos</div>
<div class="pill" onclick="filterSegEstado('PENDIENTE',this)" title="Cliente en gestiÃ³n de renovaciÃ³n. Sin confirmaciÃ³n aÃºn." style="font-size:11px">âšª Pendiente</div><div class="pill" onclick="filterSegEstado('INSPECCIÃ“N',this)" title="VehÃ­culo pendiente de inspecciÃ³n requerida por aseguradora." style="font-size:11px">ğŸ” InspecciÃ³n</div><div class="pill" onclick="filterSegEstado('EMISIÃ“N',this)" title="PÃ³liza en trÃ¡mite de emisiÃ³n. AÃºn no activa." style="font-size:11px">ğŸ“ EmisiÃ³n</div><div class="pill" onclick="filterSegEstado('EMITIDO',this)" title="PÃ³liza emitida formalmente y activa." style="font-size:11px">ğŸ“„ Emitido</div><div class="pill" onclick="filterSegEstado('RENOVADO',this)" title="RenovaciÃ³n completada exitosamente." style="font-size:11px">âœ… Renovado</div><div class="pill" onclick="filterSegEstado('PÃ“LIZA VIGENTE',this)" title="PÃ³liza activa dentro del perÃ­odo de cobertura." style="font-size:11px">ğŸ›¡ PÃ³liza Vigente</div><div class="pill" onclick="filterSegEstado('CRÃ‰DITO VENCIDO',this)" title="Cliente mantiene cuotas vencidas con el banco que financia el vehÃ­culo." style="font-size:11px">â° CrÃ©dito Vencido</div><div class="pill" onclick="filterSegEstado('CRÃ‰DITO CANCELADO',this)" title="Cliente cancelÃ³ totalmente su crÃ©dito con el banco." style="font-size:11px">ğŸ’³ CrÃ©dito Cancelado</div><div class="pill" onclick="filterSegEstado('SINIESTRO',this)" title="Cliente con evento reportado en trÃ¡mite con la aseguradora." style="font-size:11px">ğŸš¨ Siniestro</div><div class="pill" onclick="filterSegEstado('PÃ‰RDIDA TOTAL',this)" title="VehÃ­culo declarado pÃ©rdida total por la aseguradora." style="font-size:11px">ğŸš— PÃ©rdida Total</div><div class="pill" onclick="filterSegEstado('PÃ“LIZA ANULADA',this)" title="PÃ³liza cancelada antes del vencimiento." style="font-size:11px">âŒ PÃ³liza Anulada</div><div class="pill" onclick="filterSegEstado('ENDOSO',this)" title="Cliente realizÃ³ el seguro directamente sin intermediaciÃ³n de Reliance." style="font-size:11px">ğŸ“‹ Endoso</div><div class="pill" onclick="filterSegEstado('NO RENOVADO',this)" title="Cliente decidiÃ³ no renovar la pÃ³liza al vencimiento." style="font-size:11px">ğŸš« No Renovado</div><div class="pill" onclick="filterSegEstado('INUBICABLE',this)" title="No se logra contacto con el cliente tras varios intentos." style="font-size:11px">ğŸ“µ Inubicable</div><div class="pill" onclick="filterSegEstado('NO ASEGURABLE',this)" title="Riesgo rechazado por aseguradora." style="font-size:11px">â›” No Asegurable</div><div class="pill" onclick="filterSegEstado('AUTO VENDIDO',this)" title="Cliente ya no posee el vehÃ­culo asegurado." style="font-size:11px">ğŸ”‘ Auto Vendido</div><div class="pill" onclick="filterSegEstado('CLIENTE FALLECIDO',this)" title="Titular fallecido. Se cierra gestiÃ³n o se coordina con herederos." style="font-size:11px">ğŸ•Š Cliente Fallecido</div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">MÃ³dulo de Seguimiento</div><span class="text-muted" style="font-size:12px" id="seg-count">â€”</span></div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Cliente</th><th>Aseguradora</th><th>Vence</th><th>DÃ­as</th><th>Estado</th><th>Nota</th><th>Ãšlt. contacto</th><th>Acciones</th></tr></thead>
          <tbody id="seguimiento-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â•â• COTIZADOR â•â• -->
  <div class="page" id="page-cotizador">
    <div class="cotizador-header">
      <h2>Cotizador de Seguros Vehiculares</h2>
      <p>Compare primas entre aseguradoras en tiempo real Â· ImpresiÃ³n PDF profesional</p>
    </div>
    <div class="grid-2" style="margin-bottom:20px">
      <div class="card">
        <div class="card-header"><div class="card-title">Datos del Cliente</div></div>
        <div class="card-body">
          <div class="form-grid form-grid-2" style="gap:12px">
            <div class="form-group"><label class="form-label">Nombre Completo</label><input class="form-input" id="cot-nombre" placeholder="Apellidos y nombres"></div>
            <div class="form-group"><label class="form-label">CÃ©dula / RUC</label><input class="form-input" id="cot-ci" placeholder="1234567890"></div>
            <div class="form-group"><label class="form-label">Celular</label><input class="form-input" id="cot-cel" placeholder="593987654321"></div>
            <div class="form-group"><label class="form-label">Correo</label><input class="form-input" id="cot-email" placeholder="cliente@email.com"></div>
            <div class="form-group"><label class="form-label">Ciudad</label><select class="form-select" id="cot-ciudad"><option>QUITO</option><option>GUAYAQUIL</option><option>CUENCA</option><option>SALINAS</option><option>PORTOVIEJO</option><option>AMBATO</option></select></div>
            <div class="form-group"><label class="form-label">RegiÃ³n</label><select class="form-select" id="cot-region"><option value="SIERRA">SIERRA</option><option value="COSTA">COSTA</option></select></div>
            <div class="form-group"><label class="form-label">Tipo de PÃ³liza</label><select class="form-select" id="cot-tipo"><option value="NUEVO">NUEVA</option><option value="RENOVACION">RENOVACIÃ“N</option></select></div>
            <div class="form-group"><label class="form-label">Vigencia Desde</label><input class="form-input" type="date" id="cot-desde"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Datos del VehÃ­culo</div></div>
        <div class="card-body">
          <div class="form-grid form-grid-2" style="gap:12px">
            <div class="form-group"><label class="form-label">Marca</label><select class="form-select" id="cot-marca"><option>CHERY</option><option>KIA</option><option>VOLKSWAGEN</option><option>FIAT</option><option>NISSAN</option><option>TOYOTA</option><option>MAZDA</option><option>HYUNDAI</option><option>CHEVROLET</option><option>GREAT WALL</option><option>OTRO</option></select></div>
            <div class="form-group"><label class="form-label">AÃ±o</label><input class="form-input" id="cot-anio" type="number" value="2024" min="2000" max="2026"></div>
            <div class="form-group full"><label class="form-label">Modelo</label><input class="form-input" id="cot-modelo" placeholder="Ej: TIGGO 7 PRO AC 1.5 5P"></div>
            <div class="form-group"><label class="form-label">Placa</label><input class="form-input" id="cot-placa" placeholder="T03XXXXX"></div>
            <div class="form-group"><label class="form-label">Color</label><input class="form-input" id="cot-color" placeholder="BLANCO"></div>
            <div class="form-group"><label class="form-label">NÂ° Motor</label><input class="form-input" id="cot-motor" placeholder="NÂ° Motor" style="font-family:'DM Mono',monospace;font-size:12px"></div>
            <div class="form-group"><label class="form-label">NÂ° Chasis</label><input class="form-input" id="cot-chasis" placeholder="NÂ° Chasis" style="font-family:'DM Mono',monospace;font-size:12px"></div>
            <div class="form-group"><label class="form-label">Valor Asegurado ($)</label><input class="form-input" id="cot-va" type="number" value="20000" oninput="calcCotizacion()"></div>
            <div class="form-group"><label class="form-label">Extras ($)</label><input class="form-input" id="cot-extras" type="number" value="0"></div>
            <div class="form-group"><label class="form-label">Cuotas TC</label><select class="form-select" id="cot-cuotas-tc" onchange="calcCotizacion()"><option value="3">3</option><option value="6">6</option><option value="9">9</option><option value="12" selected>12</option></select></div>
            <div class="form-group"><label class="form-label">Cuotas DÃ©bito</label><select class="form-select" id="cot-cuotas-deb" onchange="calcCotizacion()"><option value="8">8</option><option value="10" selected>10</option><option value="12">12</option></select></div>
          </div>
          <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px">PÃ³liza Anterior (RenovaciÃ³n)</div>
            <div class="form-grid form-grid-2" style="gap:10px">
              <div class="form-group"><label class="form-label">Aseguradora Anterior</label><input class="form-input" id="cot-aseg-anterior" placeholder="Ej: GENERALI ECUADOR"></div>
              <div class="form-group"><label class="form-label">NÂ° PÃ³liza Anterior</label><input class="form-input" id="cot-poliza-anterior" placeholder="000000-000000" style="font-family:'DM Mono',monospace"></div>
            </div>
          </div>
          <div style="margin-top:16px;display:flex;gap:8px">
            <!-- Selector de aseguradoras -->
            <div style="margin-bottom:12px">
              <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:8px">Aseguradoras a cotizar</div>
              <div id="aseg-selector" style="display:grid;grid-template-columns:1fr 1fr;gap:6px"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn btn-ghost btn-xs" onclick="toggleAllAseg(true)">âœ“ Todas</button>
                <button class="btn btn-ghost btn-xs" onclick="toggleAllAseg(false)">âœ— Ninguna</button>
              </div>
            </div>
            <button class="btn btn-primary w-full" onclick="calcCotizacion()">ğŸ§® Calcular Primas</button>
          </div>
        </div>
      </div>
    </div>
    <div id="cotizacion-resultado" style="display:none">
      <div class="card" style="margin-bottom:20px">
        <div class="card-header">
          <div class="card-title">Comparativo de Primas</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <!-- Toggle Auto Sustituto SWEADEN â€” solo visible cuando SWEADEN estÃ¡ en resultados -->
            <label id="sweaden-autosust-wrap" style="display:none;align-items:center;gap:7px;background:#e8f0fb;border:1px solid #1a4c84;border-radius:7px;padding:5px 12px;cursor:pointer;font-size:12px;color:#1a4c84;font-weight:500;user-select:none">
              <input type="checkbox" id="sweaden-autosust" onchange="calcCotizacion()" style="accent-color:#1a4c84;width:15px;height:15px;cursor:pointer">
              ğŸš— Auto Sustituto SWEADEN <span style="background:#1a4c84;color:#fff;border-radius:4px;padding:1px 7px;font-size:11px;margin-left:2px">+$60</span>
            </label>
            <button class="btn btn-blue btn-sm" onclick="printCotizacion()">ğŸ–¨ Imprimir / PDF</button>
            <button class="btn btn-green btn-sm" onclick="guardarCotizacion()">ğŸ’¾ Guardar</button>
          </div>
        </div>
        <div class="card-body"><div class="aseg-cards" id="aseg-cards-result"></div></div>
      </div>
      <div class="card"><div class="card-header"><div class="card-title">Coberturas Comparadas</div></div><div class="tbl-wrap" id="coberturas-table-wrap"></div></div>
    </div>
  </div>

  <!-- â•â• COTIZACIONES â•â• -->
  <div class="page" id="page-cotizaciones">

    <!-- Header con KPIs -->
    <div class="highlight-card" style="background:linear-gradient(135deg,#e8f0fb,#d0e4ff);border-color:var(--accent2);margin-bottom:20px">
      <div class="flex items-center justify-between">
        <div>
          <div style="font-family:'DM Serif Display',serif;font-size:18px;color:var(--accent2)">Cotizaciones</div>
          <div class="text-muted" style="font-size:12px">Seguimiento de cotizaciones enviadas a clientes</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="showPage('cotizador')">+ Nueva CotizaciÃ³n</button>
      <button class="btn btn-green btn-sm" onclick="exportarCotizAceptadas()">â¬‡ Excel Aceptadas</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid-4" style="margin-bottom:20px">
      <div class="stat-card"><div class="stat-label">Total enviadas</div><div class="stat-value" id="cq-stat-total">0</div></div>
      <div class="stat-card"><div class="stat-label">Pendientes respuesta</div><div class="stat-value" style="color:var(--accent)" id="cq-stat-pend">0</div></div>
      <div class="stat-card"><div class="stat-label">Aceptadas</div><div class="stat-value" style="color:var(--green)" id="cq-stat-acept">0</div></div>
      <div class="stat-card"><div class="stat-label">Tasa de cierre</div><div class="stat-value" style="color:var(--accent2)" id="cq-stat-tasa">0%</div></div>
    </div>

    <!-- Filtros -->
    <div class="card" style="margin-bottom:16px">
      <div class="card-body" style="padding:12px 16px">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <input class="form-input" id="cq-search" placeholder="ğŸ” Buscar cliente..." style="width:220px" oninput="renderCotizaciones()">
          <select class="form-select" id="cq-filter-estado" style="width:170px" onchange="renderCotizaciones()">
            <option value="">Todos los estados</option>
            <option value="ENVIADA">ğŸ“¤ Enviada</option>
            <option value="VISTA">ğŸ‘ Vista</option>
            <option value="ACEPTADA">âœ… Aceptada</option>
            <option value="EN EMISIÃ“N">ğŸ“ En EmisiÃ³n</option>
            <option value="EMITIDA">ğŸ›¡ Emitida</option>
            <option value="RECHAZADA">âŒ Rechazada</option>
            <option value="VENCIDA">âŒ› Vencida</option>
          </select>
          <select class="form-select" id="cq-filter-aseg" style="width:170px" onchange="renderCotizaciones()">
            <option value="">Todas las aseguradoras</option>
          </select>
          <div style="margin-left:auto;font-size:12px;color:var(--muted)" id="cq-count"></div>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card">
      <div class="tbl-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>VehÃ­culo</th>
              <th style="text-align:right">VA</th>
              <th>Aseguradoras cotizadas</th>
              <th>Estado</th>
              <th>Aseg. Elegida</th>
              <th>Ejecutivo</th>
              <th style="text-align:center">Acciones</th>
            </tr>
          </thead>
          <tbody id="cq-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL confirmar aceptaciÃ³n -->
  <div class="modal-overlay" id="modal-cotiz-aceptar">
    <div class="modal" style="max-width:520px">
      <div class="modal-header">
        <div class="modal-title">âœ… Cliente Acepta â€” Confirmar Aseguradora</div>
        <button class="modal-close" onclick="closeModal('modal-cotiz-aceptar')">âœ•</button>
      </div>
      <div class="modal-body">
        <div id="modal-cotiz-cliente-info" style="padding:12px;background:var(--warm);border-radius:8px;margin-bottom:16px;font-size:13px"></div>

        <div class="form-group">
          <label class="form-label">Aseguradora elegida por el cliente</label>
          <div id="cotiz-aseg-options" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px"></div>
        </div>

        <div id="cotiz-resumen-elegida" style="display:none;margin-top:16px;padding:14px;border-radius:8px;border:2px solid var(--border)">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:10px">Resumen de la opciÃ³n elegida</div>
          <div id="cotiz-resumen-body" style="font-size:13px"></div>
        </div>

        <div class="form-group" style="margin-top:16px">
          <label class="form-label">ObservaciÃ³n (opcional)</label>
          <input class="form-input" id="cotiz-obs-acept" placeholder="Ej: Cliente prefiriÃ³ dÃ©bito bancario">
        </div>

        <div style="background:#e8f0fb;border:1px solid var(--accent2);border-radius:8px;padding:12px;margin-top:12px;font-size:12px;color:var(--accent2)">
          <b>ğŸ“‹ Â¿QuÃ© pasarÃ¡ al confirmar?</b><br>
          â€¢ La cotizaciÃ³n cambiarÃ¡ a estado <b>ACEPTADA</b><br>
          â€¢ El cliente pasarÃ¡ a estado <b>EMISIÃ“N</b> en la cartera<br>
          â€¢ Se abrirÃ¡ el formulario de cierre de venta pre-llenado
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('modal-cotiz-aceptar')">Cancelar</button>
        <button class="btn btn-green" onclick="confirmarAceptacion()" id="btn-confirmar-acept" disabled>âœ… Confirmar AceptaciÃ³n</button>
      </div>
    </div>
  </div>

  <!-- â•â• COMPARATIVO â•â• -->
  <div class="page" id="page-comparativo">
    <div class="highlight-card"><div class="flex items-center justify-between"><div><div style="font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:4px">Comparativo Completo de Aseguradoras</div><div class="text-muted" style="font-size:12px">Coberturas, amparos adicionales, beneficios y deducibles</div></div></div></div>
    <div class="card"><div class="card-header"><div class="card-title">Coberturas y Beneficios</div></div><div class="tbl-wrap"><table class="comp-table"><thead><tr><th class="col-cob" style="text-align:left">Cobertura</th></tr></thead><tbody id="comp-tbody"></tbody></table></div></div>
  </div>

  <!-- â•â• TASAS â•â• -->
  <div class="page" id="page-tasas">
    <div class="grid-3">
      <div class="card"><div class="card-header" style="background:rgba(26,76,132,.06)"><div class="card-title" style="color:var(--accent2)">SWEADEN</div></div><div class="card-body"><table style="width:100%;font-size:12px"><thead><tr><th style="text-align:left;padding:4px 8px;color:var(--muted);font-size:10px">Valor Asegurado</th><th style="padding:4px 8px;color:var(--muted);font-size:10px">UIO</th><th style="padding:4px 8px;color:var(--muted);font-size:10px">GYE</th></tr></thead><tbody><tr><td style="padding:8px">$0â€“$20,000</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">3.50/3.70%</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">3.50/3.70%</td></tr><tr><td style="padding:8px">$20,001â€“$30,000</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.80/3.00%</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">3.00/3.20%</td></tr><tr><td style="padding:8px">$30,001+</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.50/2.70%</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.80/3.00%</td></tr></tbody></table><div style="margin-top:10px;padding:8px;background:var(--warm);border-radius:6px;font-size:11px;color:var(--muted)">1Âª tasa=RenovaciÃ³n Â· 2Âª tasa=Nuevo</div></div></div>
      <div class="card"><div class="card-header" style="background:rgba(200,75,26,.06)"><div class="card-title" style="color:var(--accent)">MAPFRE</div></div><div class="card-body"><table style="width:100%;font-size:12px"><thead><tr><th style="text-align:left;padding:4px 8px;color:var(--muted);font-size:10px">Valor Asegurado</th><th style="padding:4px 8px;color:var(--muted);font-size:10px">Renovac.</th><th style="padding:4px 8px;color:var(--muted);font-size:10px">Nuevo</th></tr></thead><tbody><tr><td style="padding:8px">$0â€“$20,000</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">3.50%</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">4.9%</td></tr><tr><td style="padding:8px">$20,001â€“$30,000</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.80%</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">3.2%</td></tr><tr><td style="padding:8px">$30,001+</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.50%</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.5%</td></tr></tbody></table></div></div>
      <div class="card"><div class="card-header" style="background:rgba(45,106,79,.06)"><div class="card-title" style="color:var(--green)">ALIANZA</div></div><div class="card-body"><table style="width:100%;font-size:12px"><thead><tr><th style="text-align:left;padding:4px 8px;color:var(--muted);font-size:10px">Valor Asegurado</th><th style="padding:4px 8px;color:var(--muted);font-size:10px">Tasa</th></tr></thead><tbody><tr><td style="padding:8px">$0â€“$20,000</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">3.00/3.20%</td></tr><tr><td style="padding:8px">$20,001â€“$30,000</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.50/2.70%</td></tr><tr><td style="padding:8px">$30,001+</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.20/2.40%</td></tr></tbody></table></div></div>
      <div class="card"><div class="card-header" style="background:rgba(184,134,11,.06)"><div class="card-title" style="color:var(--gold)">ZURICH</div></div><div class="card-body"><table style="width:100%;font-size:12px"><thead><tr><th style="text-align:left;padding:4px 8px;color:var(--muted);font-size:10px">Valor Asegurado</th><th style="padding:4px 8px;color:var(--muted);font-size:10px">Tasa</th></tr></thead><tbody><tr><td style="padding:8px">$0â€“$29,999</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">4.30%</td></tr><tr><td style="padding:8px">$30,000â€“$39,999</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.50%</td></tr><tr><td style="padding:8px">$40,000+</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.20%</td></tr></tbody></table></div></div>
      <div class="card"><div class="card-header" style="background:rgba(107,91,149,.06)"><div class="card-title" style="color:#6b5b95">LATINA</div></div><div class="card-body"><table style="width:100%;font-size:12px"><thead><tr><th style="text-align:left;padding:4px 8px;color:var(--muted);font-size:10px">Valor Asegurado</th><th style="padding:4px 8px;color:var(--muted);font-size:10px">Tasa</th></tr></thead><tbody><tr><td style="padding:8px">$0â€“$19,999</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">3.50%</td></tr><tr><td style="padding:8px">$20,000â€“$29,999</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.80%</td></tr><tr><td style="padding:8px">$30,000+</td><td style="padding:8px;text-align:center;font-family:'DM Mono',monospace">2.50%</td></tr></tbody></table></div></div>
      <div class="card"><div class="card-header"><div class="card-title">GENERALI</div></div><div class="card-body"><div style="font-size:12px;color:var(--muted);line-height:1.8"><div>Tasa nuevos: <b>4.75%</b></div><div>RenovaciÃ³n: <b>3.36â€“4.75%</b></div><div>Amparo Patrimonial: <b>con costo adicional</b></div></div></div></div>
    </div>
  </div>

  <!-- â•â• ADMIN â•â• -->
  <!-- â•â• REPORTES â•â• -->
  <div class="page" id="page-reportes">
    <div class="highlight-card" style="background:linear-gradient(135deg,#e8f0fb,#d0e4ff);border-color:var(--accent2);margin-bottom:20px">
      <div class="flex items-center justify-between">
        <div>
          <div style="font-family:'DM Serif Display',serif;font-size:18px;color:var(--accent2)">Reportes y MÃ©tricas</div>
          <div class="text-muted" style="font-size:12px">AnÃ¡lisis de cartera, renovaciones y producciÃ³n</div>
        </div>
        <div style="display:flex;gap:8px">
          <select class="form-select" id="rep-periodo" style="width:160px" onchange="renderReportes()">
            <option value="mes">Este mes</option>
            <option value="trimestre">Este trimestre</option>
            <option value="anio">Este aÃ±o</option>
            <option value="todo">Todo</option>
          </select>
          <button class="btn btn-blue btn-sm" onclick="exportarReporteExcel()">â¬‡ Exportar</button>
        </div>
      </div>
    </div>

    <!-- KPIs principales -->
    <div class="grid-4" id="rep-kpis" style="margin-bottom:24px"></div>

    <!-- GrÃ¡ficos fila 1 -->
    <div class="grid-2" style="margin-bottom:20px">
      <div class="card">
        <div class="card-header"><div class="card-title">Renovaciones por estado</div></div>
        <div class="card-body"><canvas id="rep-chart-estados" height="220"></canvas></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Cierres por aseguradora</div></div>
        <div class="card-body"><canvas id="rep-chart-aseg" height="220"></canvas></div>
      </div>
    </div>

    <!-- GrÃ¡ficos fila 2 -->
    <div class="grid-2" style="margin-bottom:20px">
      <div class="card">
        <div class="card-header"><div class="card-title">Primas por forma de pago</div></div>
        <div class="card-body"><canvas id="rep-chart-fp" height="220"></canvas></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Vencimientos prÃ³ximos 90 dÃ­as</div></div>
        <div class="card-body"><canvas id="rep-chart-venc" height="220"></canvas></div>
      </div>
    </div>

    <!-- Ranking ejecutivos -->
    <div class="card" style="margin-bottom:20px">
      <div class="card-header"><div class="card-title">ğŸ† Ranking de Ejecutivos</div></div>
      <div class="card-body" id="rep-ranking"></div>
    </div>

    <!-- Detalle cierres del perÃ­odo -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Cierres del perÃ­odo</div>
        <span class="text-muted" style="font-size:12px" id="rep-cierres-count">â€”</span>
      </div>
      <div class="tbl-wrap"><table>
        <thead><tr><th>Fecha</th><th>Cliente</th><th>Aseguradora</th><th>Prima Total</th><th>Forma Pago</th><th>Ejecutivo</th></tr></thead>
        <tbody id="rep-cierres-tbody"></tbody>
      </table></div>
    </div>
  </div>

    <div class="page" id="page-admin">
    <div class="highlight-card" style="background:linear-gradient(135deg,#fff8e1,#fff3cd);border-color:#f0c040;margin-bottom:20px">
      <div class="flex items-center justify-between">
        <div><div style="font-family:'DM Serif Display',serif;font-size:18px">Panel de AdministraciÃ³n</div>
        <div class="text-muted" style="font-size:12px">GestiÃ³n de carteras, importaciones y ejecutivos Â· Solo visible para Administradores</div></div>
        <span class="badge badge-gold">âš™ ADMIN</span>
      </div>
    </div>

    <!-- Stats admin -->
    <div class="grid-4" id="admin-stats" style="margin-bottom:20px"></div>

    <!-- Tabs -->
    <div class="filter-pills" id="admin-tabs" style="margin-bottom:20px">
      <div class="pill active" onclick="showAdminTab('importar',this)">ğŸ“¥ Importar Cartera</div>
      <div class="pill" onclick="showAdminTab('historial',this)">ğŸ“‹ Historial de Cargas</div>
      <div class="pill" onclick="showAdminTab('ejecutivos',this)">ğŸ‘¥ Ejecutivos</div>
      <div class="pill" onclick="showAdminTab('datos',this)">ğŸ—„ï¸ GestiÃ³n de Datos</div>
    </div>

    <!-- TAB: IMPORTAR -->
    <div id="admin-tab-importar">
      <div class="card" style="margin-bottom:20px">
        <div class="card-header">
          <div class="card-title">ğŸ“¥ Cargar archivo de cartera mensual</div>
          <div style="font-size:11px;color:var(--muted)">Formato Produbanco Â· Sheet "PRODU VH"</div>
        </div>
        <div class="card-body">
          <!-- Opciones de importaciÃ³n -->
          <div class="form-grid form-grid-2" style="gap:14px;margin-bottom:20px">
            <div class="form-group">
              <label class="form-label">Mes de la cartera</label>
              <input class="form-input" type="month" id="import-mes" value="">
            </div>
            <div class="form-group">
              <label class="form-label">Asignar cartera a ejecutivo</label>
              <select class="form-select" id="import-assign-exec"></select>
            </div>
            <div class="form-group">
              <label class="form-label">Modo de importaciÃ³n</label>
              <select class="form-select" id="import-modo">
                <option value="agregar">â• Agregar â€” solo nuevos clientes (no duplica existentes)</option>
                <option value="actualizar">ğŸ”„ Actualizar â€” actualiza datos si el cliente ya existe</option>
                <option value="reemplazar">âš  Reemplazar â€” elimina cartera del ejecutivo y carga nueva</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Hoja del archivo</label>
              <select class="form-select" id="import-sheet">
                <option value="auto">Auto-detectar (busca "VH")</option>
                <option value="PRODU VH">PRODU VH</option>
                <option value="PRODUCTOS PRODUBANCO">PRODUCTOS PRODUBANCO</option>
              </select>
            </div>
          </div>
          <!-- Drop zone -->
          <div class="drop-zone" id="drop-zone"
            onclick="document.getElementById('excel-input').click()"
            ondragover="handleDragOver(event)"
            ondragleave="handleDragLeave(event)"
            ondrop="handleDrop(event)">
            <div class="drop-icon">ğŸ“Š</div>
            <div class="drop-text">Arrastra el archivo Excel aquÃ­ o haz clic para seleccionar</div>
            <div class="drop-sub">Soporta .xlsx Â· .xls Â· .xlsm â€” Mapeo automÃ¡tico formato Produbanco</div>
          </div>
          <input type="file" id="excel-input" accept=".xlsx,.xls,.xlsm" style="display:none" onchange="handleFileSelect(event)">
        </div>
      </div>

      <!-- Preview -->
      <div id="import-preview" style="display:none">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Vista previa de importaciÃ³n</div>
            <div id="import-preview-meta" style="font-size:12px;color:var(--muted)"></div>
          </div>
          <div class="card-body">
            <!-- Resumen de mapeo -->
            <div id="import-mapeo-resumen" style="margin-bottom:16px;padding:12px;background:var(--warm);border-radius:8px;font-size:12px"></div>
            <div id="import-table-wrap" class="tbl-wrap" style="max-height:320px;overflow-y:auto"></div>
            <div style="margin-top:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <button class="btn btn-green" onclick="confirmImport()">âœ“ Confirmar e Importar</button>
              <button class="btn btn-ghost" onclick="cancelImport()">âœ• Cancelar</button>
              <div style="margin-left:auto;font-size:12px;color:var(--muted)" id="import-warning"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: HISTORIAL -->
    <div id="admin-tab-historial" style="display:none">
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“‹ Historial de Cargas</div></div>
        <div class="card-body">
          <div id="import-historial-wrap">
            <div class="empty-state"><div class="empty-icon">ğŸ“‚</div><p>No hay cargas registradas aÃºn</p></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: EJECUTIVOS -->
    <div id="admin-tab-ejecutivos" style="display:none">
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ‘¥ Ejecutivos y Carteras</div>
          <button class="btn btn-primary btn-sm" onclick="openModalNewExec()">+ Agregar Ejecutivo</button>
        </div>
        <div class="card-body">
          <div id="exec-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px"></div>
        </div>
      </div>
    </div>

    <!-- TAB: GESTIÃ“N DE DATOS -->
    <div id="admin-tab-datos" style="display:none">
      <div class="grid-2">
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ—„ï¸ Base de Datos</div></div>
          <div class="card-body">
            <div id="admin-db-stats" style="margin-bottom:16px"></div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <button class="btn btn-secondary w-full" onclick="exportarTodoExcel()">â¬‡ Exportar todos los clientes a Excel</button>
              <button class="btn btn-secondary w-full" onclick="exportarBackupJSON()">ğŸ’¾ Backup completo (JSON)</button>
              <button class="btn btn-secondary w-full" onclick="document.getElementById('restore-input').click()">ğŸ“‚ Restaurar desde backup</button>
              <input type="file" id="restore-input" accept=".json" style="display:none" onchange="restaurarBackup(event)">
              <hr style="border:none;border-top:1px solid var(--border);margin:4px 0">
              <button class="btn w-full" style="background:#fff0f0;color:var(--red);border:1px solid var(--red)" onclick="limpiarCarteraEjecutivo()">ğŸ§¹ Limpiar cartera de un ejecutivo</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ“Š Resumen por ejecutivo</div></div>
          <div class="card-body">
            <div id="admin-exec-resumen"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• NUEVO CLIENTE â•â• -->
  <div class="page" id="page-nuevo-cliente">
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><div class="card-title">Datos del Cliente</div></div>
        <div class="card-body">
          <div class="form-grid form-grid-2" style="gap:12px">
            <div class="form-group full"><label class="form-label">Nombre Completo</label><input class="form-input" id="nc-nombre" placeholder="APELLIDOS NOMBRES"></div>
            <div class="form-group"><label class="form-label">CI / RUC</label><input class="form-input" id="nc-ci"></div>
            <div class="form-group"><label class="form-label">Celular</label><input class="form-input" id="nc-cel"></div>
            <div class="form-group"><label class="form-label">Correo</label><input class="form-input" id="nc-email" type="email"></div>
            <div class="form-group"><label class="form-label">Ciudad</label><select class="form-select" id="nc-ciudad"><option>QUITO</option><option>GUAYAQUIL</option><option>CUENCA</option><option>SALINAS</option><option>PORTOVIEJO</option><option>AMBATO</option></select></div>
            <div class="form-group"><label class="form-label">RegiÃ³n</label><select class="form-select" id="nc-region"><option value="SIERRA">SIERRA</option><option value="COSTA">COSTA</option></select></div>
            <div class="form-group"><label class="form-label">Nacimiento</label><input class="form-input" type="date" id="nc-nacimiento"></div>
            <div class="form-group"><label class="form-label">GÃ©nero</label><select class="form-select" id="nc-genero"><option>MASCULINO</option><option>FEMENINO</option></select></div>
            <div class="form-group"><label class="form-label">Estado Civil</label><select class="form-select" id="nc-civil"><option>SOLTERO</option><option>CASADO</option><option>DIVORCIADO</option><option>VIUDO</option></select></div>
            <div class="form-group"><label class="form-label">ProfesiÃ³n</label><input class="form-input" id="nc-profesion"></div>
            <div class="form-group full"><label class="form-label">DirecciÃ³n</label><input class="form-input" id="nc-dir"></div>
          </div>
        </div>
      </div>
      <div>
        <div class="card" style="margin-bottom:16px">
          <div class="card-header"><div class="card-title">Datos del VehÃ­culo</div></div>
          <div class="card-body">
            <div class="form-grid form-grid-2" style="gap:12px">
              <div class="form-group"><label class="form-label">Marca</label><select class="form-select" id="nc-marca"><option>CHERY</option><option>KIA</option><option>VOLKSWAGEN</option><option>FIAT</option><option>NISSAN</option><option>TOYOTA</option><option>MAZDA</option><option>HYUNDAI</option><option>CHEVROLET</option><option>GREAT WALL</option><option>OTRO</option></select></div>
              <div class="form-group"><label class="form-label">AÃ±o</label><input class="form-input" type="number" id="nc-anio" value="2025"></div>
              <div class="form-group full"><label class="form-label">Modelo</label><input class="form-input" id="nc-modelo"></div>
              <div class="form-group"><label class="form-label">Placa</label><input class="form-input" id="nc-placa"></div>
              <div class="form-group"><label class="form-label">Color</label><input class="form-input" id="nc-color"></div>
              <div class="form-group"><label class="form-label">NÂº Chasis</label><input class="form-input" id="nc-chasis"></div>
              <div class="form-group"><label class="form-label">Cuenta Produbanco</label><input class="form-input" id="nc-cuenta"></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Datos de la PÃ³liza</div></div>
          <div class="card-body">
            <div class="form-grid form-grid-2" style="gap:12px">
              <div class="form-group"><label class="form-label">Tipo</label><select class="form-select" id="nc-tipo"><option value="NUEVO">NUEVO</option><option value="RENOVACION">RENOVACIÃ“N</option></select></div>
              <div class="form-group"><label class="form-label">Aseguradora</label><select class="form-select" id="nc-aseg"><option value="ALIANZA SEGUROS">ALIANZA SEGUROS</option><option value="SWEADEN SEGUROS">SWEADEN SEGUROS</option><option value="ASEGURADORA DEL SUR">ASEGURADORA DEL SUR</option><option value="LATINA SEGUROS">LATINA SEGUROS</option><option value="ZURICH">ZURICH</option><option value="GENERALI ECUADOR">GENERALI ECUADOR</option><option value="MAPFRE SEGUROS">MAPFRE SEGUROS</option><option value="SEGUROS EQUINOCCIAL">SEGUROS EQUINOCCIAL</option><option value="ATLANTIDA">ATLANTIDA</option><option value="AIG">AIG</option><option value="OTRO">OTRO</option></select></div>
              <div class="form-group"><label class="form-label">Val. Asegurado ($)</label><input class="form-input" type="number" id="nc-va"></div>
              <div class="form-group"><label class="form-label">Tasa (%)</label><input class="form-input" type="number" step="0.01" id="nc-tasa"></div>
              <div class="form-group"><label class="form-label">Vigencia Desde</label><input class="form-input" type="date" id="nc-desde"></div>
              <div class="form-group"><label class="form-label">Vigencia Hasta</label><input class="form-input" type="date" id="nc-hasta"></div>
              <div class="form-group full"><label class="form-label">OBS</label><select class="form-select" id="nc-obs"><option>NUEVO</option><option>RENOVACION</option><option>ENDOSO</option><option>RENOVACION+VD</option><option>RENOVACION+AXA</option><option>RENOVACION+VD+AXA</option></select></div>
              <div class="form-group full"><label class="form-label">Comentarios</label><textarea class="form-textarea" id="nc-comentario"></textarea></div>
            </div>
            <div style="margin-top:16px;display:flex;gap:10px">
              <button class="btn btn-primary w-full" onclick="guardarNuevoCliente()">ğŸ’¾ Registrar Cliente</button>
              <button class="btn btn-secondary" onclick="showPage('cotizador')">ğŸ§® Cotizar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- â•â• CIERRES DE VENTA â•â• -->
  <div class="page" id="page-cierres">
    <div class="highlight-card" style="background:linear-gradient(135deg,#d4edda,#c3e6cb);border-color:var(--green);margin-bottom:20px">
      <div class="flex items-center justify-between">
        <div><div style="font-family:'DM Serif Display',serif;font-size:18px;color:var(--green)">Cierres de Venta Registrados</div>
        <div class="text-muted" style="font-size:12px">Historial completo de pÃ³lizas emitidas con datos de cobro</div></div>
        <button class="btn btn-green btn-sm" onclick="exportCierresExcel()">â¬‡ Exportar Excel</button>
      </div>
    </div>
    <!-- Stats -->
    <div class="grid-4" id="cierres-stats" style="margin-bottom:20px"></div>
    <!-- Filtros -->
    <div class="card" style="margin-bottom:16px">
      <div class="card-body" style="padding:12px 16px">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <input class="form-input" id="cierres-search" placeholder="ğŸ” Buscar cliente, pÃ³liza, facturaâ€¦" style="flex:1;min-width:200px" oninput="renderCierres()">
          <select class="form-select" id="cierres-filter-aseg" style="width:160px" onchange="renderCierres()">
            <option value="">Todas las aseg.</option>
            <option>GENERALI</option><option>SWEADEN</option><option>ALIANZA</option>
            <option>MAPFRE</option><option>LATINA</option><option>ZURICH</option>
          </select>
          <select class="form-select" id="cierres-filter-fp" style="width:150px" onchange="renderCierres()">
            <option value="">Todas las formas</option>
            <option value="DEBITO_BANCARIO">ğŸ¦ DÃ©bito</option>
            <option value="TARJETA_CREDITO">ğŸ’³ TC</option>
            <option value="CONTADO">ğŸ’µ Contado</option>
            <option value="MIXTO">ğŸ”€ Mixto</option>
          </select>
          <select class="form-select" id="cierres-filter-mes" style="width:140px" onchange="renderCierres()">
            <option value="">Todos los meses</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">Historial de Cierres</div><span class="text-muted" style="font-size:12px" id="cierres-count">â€”</span></div>
      <div class="tbl-wrap"><table>
        <thead><tr><th>Fecha</th><th>Cliente</th><th>Aseguradora</th><th>PÃ³liza</th><th>Factura</th><th>Prima Total</th><th>Forma de Pago</th><th>Banco / Cuenta</th><th>Vigencia</th><th>AXA/VD</th><th>Acciones</th></tr></thead>
        <tbody id="cierres-tbody"></tbody>
      </table></div>
    </div>
  </div>

</div><!-- /main -->

<!-- â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â• -->
<!-- Modal Detalle Cliente -->
<div class="modal-overlay" id="modal-cliente">
  <div class="modal modal-lg">
    <div class="modal-header"><div class="modal-title" id="modal-cliente-title">Cliente</div><button class="modal-close" onclick="closeModal('modal-cliente')">âœ•</button></div>
    <div class="modal-body" id="modal-cliente-body"></div>
    <div class="modal-footer">
      <button class="btn btn-red btn-sm" id="modal-btn-eliminar">ğŸ—‘ Eliminar</button>
      <button class="btn btn-secondary" onclick="closeModal('modal-cliente')">Cerrar</button>
      <button class="btn btn-ghost" id="modal-btn-editar">âœ Editar</button>
      <button class="btn btn-blue" id="modal-btn-cotizar">ğŸ§® Cotizar</button>
    </div>
  </div>
</div>

<!-- Modal Editar Cliente -->
<div class="modal-overlay" id="modal-editar">
  <div class="modal modal-lg">
    <div class="modal-header"><div class="modal-title">Editar Cliente</div><button class="modal-close" onclick="closeModal('modal-editar')">âœ•</button></div>
    <div class="modal-body" id="modal-editar-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-editar')">Cancelar</button>
      <button class="btn btn-primary" id="modal-btn-guardar-editar">Guardar Cambios</button>
    </div>
  </div>
</div>

<!-- Modal Seguimiento -->
<div class="modal-overlay" id="modal-seguimiento">
  <div class="modal" style="max-width:580px">
    <div class="modal-header"><div class="modal-title">Actualizar Seguimiento</div><button class="modal-close" onclick="closeModal('modal-seguimiento')">âœ•</button></div>
    <div class="modal-body">
      <div id="modal-seg-nombre" style="font-weight:600;font-size:15px;margin-bottom:16px"></div>
      <div class="section-divider">Estado</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
<div style="margin-bottom:10px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:6px">ğŸ“‹ En GestiÃ³n</div><div style="display:flex;flex-wrap:wrap;gap:6px"><button class="estado-btn E1" onclick="setEstado('PENDIENTE')" title="Cliente en gestiÃ³n de renovaciÃ³n. Sin confirmaciÃ³n aÃºn." style="font-size:11px;padding:5px 10px">âšª Pendiente</button>
          <button class="estado-btn E2" onclick="setEstado('INSPECCIÃ“N')" title="VehÃ­culo pendiente de inspecciÃ³n requerida por aseguradora." style="font-size:11px;padding:5px 10px">ğŸ” InspecciÃ³n</button>
          <button class="estado-btn E3" onclick="setEstado('EMISIÃ“N')" title="PÃ³liza en trÃ¡mite de emisiÃ³n. AÃºn no activa." style="font-size:11px;padding:5px 10px">ğŸ“ EmisiÃ³n</button>
          <button class="estado-btn E4" onclick="setEstado('EMITIDO')" title="PÃ³liza emitida formalmente y activa." style="font-size:11px;padding:5px 10px">ğŸ“„ Emitido</button></div></div>
        <div style="margin-bottom:10px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:6px">âœ… Positivos</div><div style="display:flex;flex-wrap:wrap;gap:6px"><button class="estado-btn E5" onclick="setEstado('RENOVADO')" title="RenovaciÃ³n completada exitosamente." style="font-size:11px;padding:5px 10px">âœ… Renovado</button>
          <button class="estado-btn E6" onclick="setEstado('PÃ“LIZA VIGENTE')" title="PÃ³liza activa dentro del perÃ­odo de cobertura." style="font-size:11px;padding:5px 10px">ğŸ›¡ PÃ³liza Vigente</button></div></div>
        <div style="margin-bottom:10px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:6px">âš ï¸ Riesgo</div><div style="display:flex;flex-wrap:wrap;gap:6px"><button class="estado-btn E7" onclick="setEstado('CRÃ‰DITO VENCIDO')" title="Cliente mantiene cuotas vencidas con el banco que financia el vehÃ­culo." style="font-size:11px;padding:5px 10px">â° CrÃ©dito Vencido</button>
          <button class="estado-btn E8" onclick="setEstado('CRÃ‰DITO CANCELADO')" title="Cliente cancelÃ³ totalmente su crÃ©dito con el banco." style="font-size:11px;padding:5px 10px">ğŸ’³ CrÃ©dito Cancelado</button>
          <button class="estado-btn E9" onclick="setEstado('SINIESTRO')" title="Cliente con evento reportado en trÃ¡mite con la aseguradora." style="font-size:11px;padding:5px 10px">ğŸš¨ Siniestro</button>
          <button class="estado-btn E10" onclick="setEstado('PÃ‰RDIDA TOTAL')" title="VehÃ­culo declarado pÃ©rdida total por la aseguradora." style="font-size:11px;padding:5px 10px">ğŸš— PÃ©rdida Total</button></div></div>
        <div style="margin-bottom:10px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);margin-bottom:6px">ğŸ”’ Cierre/Baja</div><div style="display:flex;flex-wrap:wrap;gap:6px"><button class="estado-btn E11" onclick="setEstado('PÃ“LIZA ANULADA')" title="PÃ³liza cancelada antes del vencimiento." style="font-size:11px;padding:5px 10px">âŒ PÃ³liza Anulada</button>
          <button class="estado-btn E12" onclick="setEstado('ENDOSO')" title="Cliente realizÃ³ el seguro directamente sin intermediaciÃ³n de Reliance." style="font-size:11px;padding:5px 10px">ğŸ“‹ Endoso</button>
          <button class="estado-btn E13" onclick="setEstado('NO RENOVADO')" title="Cliente decidiÃ³ no renovar la pÃ³liza al vencimiento." style="font-size:11px;padding:5px 10px">ğŸš« No Renovado</button>
          <button class="estado-btn E14" onclick="setEstado('INUBICABLE')" title="No se logra contacto con el cliente tras varios intentos." style="font-size:11px;padding:5px 10px">ğŸ“µ Inubicable</button>
          <button class="estado-btn E15" onclick="setEstado('NO ASEGURABLE')" title="Riesgo rechazado por aseguradora." style="font-size:11px;padding:5px 10px">â›” No Asegurable</button>
          <button class="estado-btn E16" onclick="setEstado('AUTO VENDIDO')" title="Cliente ya no posee el vehÃ­culo asegurado." style="font-size:11px;padding:5px 10px">ğŸ”‘ Auto Vendido</button>
          <button class="estado-btn E17" onclick="setEstado('CLIENTE FALLECIDO')" title="Titular fallecido. Se cierra gestiÃ³n o se coordina con herederos." style="font-size:11px;padding:5px 10px">ğŸ•Š Cliente Fallecido</button></div></div>
      </div>
      <div class="section-divider">Nota de seguimiento</div>
      <textarea class="form-textarea w-full" id="seg-nota" placeholder="Resultado de la llamada, prÃ³xima acciÃ³nâ€¦" style="min-height:80px"></textarea>
      <button class="btn btn-ghost btn-sm" style="margin-top:8px;font-size:11px" onclick="nuevaTareaDesdeCliente()">
        ğŸ“Œ Agregar tarea para este cliente
      </button>

      <!-- BITÃCORA -->
      <div style="margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted)">
            ğŸ“‹ Historial de gestiÃ³n <span id="bitacora-count" style="font-weight:400;color:var(--muted)"></span>
          </div>
        </div>
        <div id="bitacora-lista" style="max-height:220px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:8px 12px;background:var(--warm)">
          <div style="color:var(--muted);font-size:12px;text-align:center;padding:12px">Sin historial de gestiÃ³n aÃºn</div>
        </div>
      </div>
    </div>
    <div id="seg-cierre-banner" style="display:none;margin:0 24px 4px;padding:12px 16px;background:#d4edda;border:1px solid #2d6a4f;border-radius:8px">
      <div style="font-size:12px;font-weight:700;color:var(--green);margin-bottom:6px">âœ“ Estado: RENOVADO â€” Â¿Registrar cierre de venta?</div>
      <div style="font-size:11px;color:#2d5a3f;margin-bottom:8px">Guarda el estado y abre el formulario de cierre (factura, pÃ³liza, forma de pago).</div>
      <button class="btn btn-green btn-sm w-full" onclick="guardarSeguimientoYCierre()">ğŸ“‹ Guardar y Registrar Cierre</button>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-seguimiento')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarSeguimiento()">Solo guardar estado</button>
    </div>
  </div>
</div>

<!-- Modal Cal Events -->
<div class="modal-overlay" id="modal-cal">
  <div class="modal" style="max-width:500px">
    <div class="modal-header"><div class="modal-title" id="modal-cal-title">Vencimientos del dÃ­a</div><button class="modal-close" onclick="closeModal('modal-cal')">âœ•</button></div>
    <div class="modal-body" id="modal-cal-body"></div>
  </div>
</div>

<!-- Modal New Exec -->
<div class="modal-overlay" id="modal-new-exec">
  <div class="modal" style="max-width:440px">
    <div class="modal-header"><div class="modal-title">Nuevo Ejecutivo</div><button class="modal-close" onclick="closeModal('modal-new-exec')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-grid" style="gap:12px">
        <div class="form-group"><label class="form-label">Nombre Completo</label><input class="form-input" id="exec-nombre"></div>
        <div class="form-group"><label class="form-label">Usuario (email)</label><input class="form-input" id="exec-user" placeholder="nombre@reliance.ec"></div>
        <div class="form-group"><label class="form-label">ContraseÃ±a</label><input class="form-input" type="password" id="exec-pass"></div>
        <div class="form-group"><label class="form-label">Rol</label><select class="form-select" id="exec-rol"><option value="ejecutivo">Ejecutivo</option><option value="admin">Administrador</option></select></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-new-exec')">Cancelar</button>
      <button class="btn btn-primary" onclick="crearEjecutivo()">Crear</button>
    </div>
  </div>
</div>

<!-- Modal Cierre de Venta -->
<div class="modal-overlay" id="modal-cierre-venta">
  <div class="modal modal-xl">
    <div class="modal-header">
      <div>
        <div class="modal-title">âœ“ Registrar Cierre de Venta</div>
        <div style="font-size:12px;color:var(--green);font-weight:600" id="cv-aseg">â€”</div>
        <div style="font-size:11px;color:var(--muted)" id="cv-total">â€”</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-cierre-venta')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid form-grid-2" style="gap:14px">
        <!-- Datos bÃ¡sicos -->
        <div class="form-group full" style="border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:2px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent)">Datos del Cierre â€” Campos Obligatorios (*)</div>
        </div>
        <div class="form-group"><label class="form-label">Cliente <span style="color:var(--red)">*</span></label><input class="form-input" id="cv-cliente" readonly style="background:var(--warm)"></div>
        <div class="form-group">
          <label class="form-label">Aseguradora con que se cerrÃ³ <span style="color:var(--red)">*</span></label>
          <select class="form-select" id="cv-nueva-aseg" onchange="cierreVentaData.asegNombre=this.value;renderCvFormaPago()">
            <option value="">â€” Seleccionar â€”</option>
            <option value="ALIANZA SEGUROS">ALIANZA SEGUROS</option>
            <option value="SWEADEN SEGUROS">SWEADEN SEGUROS</option>
            <option value="ASEGURADORA DEL SUR">ASEGURADORA DEL SUR</option>
            <option value="LATINA SEGUROS">LATINA SEGUROS</option>
            <option value="ZURICH">ZURICH</option>
            <option value="GENERALI ECUADOR">GENERALI ECUADOR</option>
            <option value="MAPFRE SEGUROS">MAPFRE SEGUROS</option>
            <option value="SEGUROS EQUINOCCIAL">SEGUROS EQUINOCCIAL</option>
            <option value="ATLANTIDA">ATLANTIDA</option>
            <option value="AIG">AIG</option>
            <option value="OTRO">OTRO</option>
          </select>
        </div>
        <div class="form-group">
  <label class="form-label">NÂ° de Factura Aseguradora <span style="color:var(--red)">*</span></label>
  <input class="form-input" id="cv-factura"
    placeholder="001-001-000000000"
    maxlength="17"
    oninput="maskFactura(this)"
    onkeydown="return allowFacturaKey(event)"
    style="font-family:'DM Mono',monospace;letter-spacing:1px"
    autocomplete="off">
  <div style="font-size:10px;color:var(--muted);margin-top:3px">Formato SRI: <span style="font-family:'DM Mono',monospace">001-001-000000000</span></div>
  <div id="cv-factura-error" style="display:none;font-size:11px;color:var(--red);margin-top:3px"></div>
</div>
        <div class="form-group"><label class="form-label">NÂ° de PÃ³liza Nueva <span style="color:var(--red)">*</span></label><input class="form-input" id="cv-poliza" placeholder="000000-000000"></div>
        <div class="form-group"><label class="form-label">Vigencia Desde <span style="color:var(--red)">*</span></label><input class="form-input" type="date" id="cv-desde" onchange="autocalcHasta()"></div>
        <div class="form-group"><label class="form-label">Vigencia Hasta <span style="color:var(--red)">*</span></label><input class="form-input" type="date" id="cv-hasta"></div>
        <div class="form-group"><label class="form-label">Prima Neta <span style="color:var(--red)">*</span></label><input class="form-input" id="cv-pn" type="number" step="0.01" placeholder="0.00" oninput="recalcPrimaTotal()"></div>
        <div class="form-group"><label class="form-label">Prima Total <span style="color:var(--red)">*</span></label><input class="form-input" id="cv-total-val" type="number" step="0.01" placeholder="0.00" oninput="syncCuotasTotal()"></div>
        <div class="form-group"><label class="form-label">Cuenta Produbanco</label><input class="form-input" id="cv-cuenta" placeholder="NÂº de cuenta" style="font-family:'DM Mono',monospace"></div>
        <div class="form-group"><label class="form-label">AXA / VD</label>
          <select class="form-select" id="cv-axavd">
            <option value="">Sin AXA ni VD</option>
            <option value="AXA">AXA</option>
            <option value="VD">VD (Vida Desgravamen)</option>
            <option value="AXA+VD">AXA + VD</option>
          </select>
        </div>
        <!-- Forma de pago -->
        <div class="form-group full" style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px">
          <label class="form-label">Forma de Pago <span style="color:var(--red)">*</span></label>
          <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
            <button class="pill active" onclick="selFormaPago('DEBITO_BANCARIO',this)">ğŸ¦ DÃ©bito Bancario</button>
            <button class="pill" onclick="selFormaPago('TARJETA_CREDITO',this)">ğŸ’³ Tarjeta de CrÃ©dito</button>
            <button class="pill" onclick="selFormaPago('CONTADO',this)">ğŸ’µ Contado/Transferencia</button>
            <button class="pill" onclick="selFormaPago('MIXTO',this)">ğŸ”€ Mixto</button>
          </div>
          <input type="hidden" id="cv-forma-pago" value="DEBITO_BANCARIO">
        </div>
        <div class="form-group full" id="cv-cuotas-wrap" style="margin-top:4px"></div>
        <div class="form-group full" style="border-top:1px solid var(--border);padding-top:12px">
          <label class="form-label">Observaciones / Notas</label>
          <textarea class="form-textarea w-full" id="cv-observacion" placeholder="Notas del cierre, acuerdos especialesâ€¦" style="min-height:60px"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div style="flex:1;font-size:11px;color:var(--muted)">âš  Todos los campos marcados con * son obligatorios</div>
      <button class="btn btn-secondary" onclick="closeModal('modal-cierre-venta')">Cancelar</button>
      <button class="btn btn-green" onclick="guardarCierreVenta()">âœ“ Registrar Cierre</button>
    </div>
  </div>
</div>

<!-- Modal WhatsApp -->
<div class="modal-overlay" id="modal-whatsapp">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div>
        <div class="modal-title" style="display:flex;align-items:center;gap:10px">
          <span style="font-size:22px">ğŸ’¬</span> WhatsApp
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="wa-cliente-meta">â€”</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-whatsapp')">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- Selector plantilla -->
      <div class="section-divider">Tipo de mensaje</div>
      <div class="filter-pills" id="wa-tipo-pills" style="margin-bottom:16px">
        <div class="pill active" onclick="selWaPlantilla('vencimiento',this)">â° Vencimiento</div>
        <div class="pill" onclick="selWaPlantilla('cotizacion',this)">ğŸ§® CotizaciÃ³n</div>
        <div class="pill" onclick="selWaPlantilla('cierre',this)">âœ… Cierre/RenovaciÃ³n</div>
        <div class="pill" onclick="selWaPlantilla('documentos',this)">ğŸ“„ Documentos</div>
        <div class="pill" onclick="selWaPlantilla('libre',this)">âœ Personalizado</div>
      </div>
      <!-- NÃºmero destino -->
      <div class="form-group" style="margin-bottom:12px">
        <label class="form-label">NÃºmero WhatsApp <span style="color:var(--red)">*</span> <span style="font-size:10px;color:var(--muted);font-weight:400">(formato: 593987654321)</span></label>
        <input class="form-input" id="wa-numero" placeholder="593987654321" style="font-family:'DM Mono',monospace">
      </div>
      <!-- Mensaje editable -->
      <div class="form-group">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <label class="form-label">Mensaje <span style="color:var(--red)">*</span></label>
          <span style="font-size:10px;color:var(--muted)" id="wa-char-count">0 caracteres</span>
        </div>
        <textarea class="form-textarea w-full" id="wa-mensaje" style="min-height:220px;font-size:13px;line-height:1.6" oninput="document.getElementById('wa-char-count').textContent=this.value.length+' caracteres'"></textarea>
      </div>
      <div style="margin-top:8px;padding:8px 12px;background:var(--warm);border-radius:6px;font-size:11px;color:var(--muted)">
        ğŸ’¡ Puedes editar el mensaje antes de enviar. Se abrirÃ¡ WhatsApp Web o la app con el mensaje listo para revisar y enviar.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-whatsapp')">Cancelar</button>
      <button class="btn btn-ghost" onclick="copiarWa()">ğŸ“‹ Copiar</button>
      <button class="btn btn-green" onclick="enviarWhatsApp()" style="background:#25D366">
        <span style="font-size:15px">ğŸ’¬</span> Abrir en WhatsApp
      </button>
    </div>
  </div>
</div>

<!-- MODAL EMAIL -->
<div class="modal-overlay" id="modal-email">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div>
        <div class="modal-title" style="display:flex;align-items:center;gap:10px">
          <span style="font-size:22px">âœ‰ï¸</span> Enviar Email
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="email-cliente-meta">â€”</div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-email')">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- Selector plantilla -->
      <div class="section-divider">Tipo de mensaje</div>
      <div class="filter-pills" id="email-tipo-pills" style="margin-bottom:16px">
        <div class="pill active" onclick="selEmailPlantilla('vencimiento',this)">â° Vencimiento</div>
        <div class="pill" onclick="selEmailPlantilla('cotizacion',this)">ğŸ§® CotizaciÃ³n</div>
        <div class="pill" onclick="selEmailPlantilla('cierre',this)">âœ… Cierre/RenovaciÃ³n</div>
        <div class="pill" onclick="selEmailPlantilla('documentos',this)">ğŸ“„ Documentos</div>
        <div class="pill" onclick="selEmailPlantilla('libre',this)">âœ Personalizado</div>
      </div>
      <!-- Destino -->
      <div class="form-group" style="margin-bottom:12px">
        <label class="form-label">Correo destinatario <span style="color:var(--red)">*</span></label>
        <input class="form-input" id="email-destino" placeholder="cliente@email.com" type="email">
      </div>
      <!-- Asunto -->
      <div class="form-group" style="margin-bottom:12px">
        <label class="form-label">Asunto</label>
        <input class="form-input" id="email-asunto" placeholder="Asunto del correo">
      </div>
      <!-- Cuerpo -->
      <div class="form-group">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <label class="form-label">Mensaje <span style="color:var(--red)">*</span></label>
          <span style="font-size:10px;color:var(--muted)" id="email-char-count">0 caracteres</span>
        </div>
        <textarea class="form-textarea w-full" id="email-cuerpo" style="min-height:220px;font-size:13px;line-height:1.6"
          oninput="document.getElementById('email-char-count').textContent=this.value.length+' caracteres'"></textarea>
      </div>
      <div style="margin-top:8px;padding:8px 12px;background:var(--warm);border-radius:6px;font-size:11px;color:var(--muted)">
        ğŸ’¡ Se abrirÃ¡ tu cliente de correo (Outlook) con el mensaje listo para revisar y enviar.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-email')">Cancelar</button>
      <button class="btn btn-ghost" onclick="copiarEmail()">ğŸ“‹ Copiar</button>
      <button class="btn btn-primary" onclick="enviarEmail()">
        <span style="font-size:15px">âœ‰ï¸</span> Abrir en Outlook
      </button>
    </div>
  </div>
</div>


<!-- MODAL NUEVA TAREA -->
<div class="modal-overlay" id="modal-tarea">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div>
        <div class="modal-title" style="display:flex;align-items:center;gap:10px">
          <span style="font-size:20px">ğŸ“Œ</span> Nueva Tarea
        </div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="tarea-cliente-meta"></div>
      </div>
      <button class="modal-close" onclick="closeModal('modal-tarea')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid form-grid-2" style="gap:12px">
        <div class="form-group full">
          <label class="form-label">TÃ­tulo <span style="color:var(--red)">*</span></label>
          <input class="form-input" id="tarea-titulo" placeholder="Ej: Llamar a Donoso para renovaciÃ³n">
        </div>
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="tarea-tipo">
            <option value="llamada">ğŸ“ Llamada</option>
            <option value="email">âœ‰ï¸ Email</option>
            <option value="reunion">ğŸ¤ ReuniÃ³n</option>
            <option value="seguimiento">ğŸ“‹ Seguimiento</option>
            <option value="otro">ğŸ“Œ Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Prioridad</label>
          <select class="form-select" id="tarea-prioridad">
            <option value="alta">ğŸ”´ Alta</option>
            <option value="media" selected>ğŸŸ¡ Media</option>
            <option value="baja">ğŸŸ¢ Baja</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Fecha <span style="color:var(--red)">*</span></label>
          <input class="form-input" type="date" id="tarea-fecha">
        </div>
        <div class="form-group">
          <label class="form-label">Hora</label>
          <input class="form-input" type="time" id="tarea-hora" placeholder="09:00">
        </div>
        <div class="form-group full">
          <label class="form-label">DescripciÃ³n / Notas</label>
          <textarea class="form-textarea w-full" id="tarea-desc" placeholder="Detalles adicionalesâ€¦" style="min-height:70px"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-tarea')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarTarea()">ğŸ“Œ Guardar tarea</button>
    </div>
  </div>
</div>

<!-- MODAL DETALLE TAREA -->
<div class="modal-overlay" id="modal-tarea-detalle">
  <div class="modal" style="max-width:460px">
    <div class="modal-header">
      <div class="modal-title" id="tarea-det-titulo">Tarea</div>
      <button class="modal-close" onclick="closeModal('modal-tarea-detalle')">âœ•</button>
    </div>
    <div class="modal-body" id="tarea-det-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-tarea-detalle')">Cerrar</button>
      <button class="btn btn-ghost" id="tarea-det-btn-completar" onclick="completarTareaDetalle()">âœ… Completar</button>
      <button class="btn btn-danger-outline" onclick="eliminarTareaDetalle()">ğŸ—‘ Eliminar</button>
    </div>
  </div>
</div>


<!-- MODAL TAREA -->


<!-- PRINT AREA (hidden, shown on print) -->
<div id="print-area" style="display:none;padding:30px;font-family:'DM Sans',sans-serif;max-width:900px;margin:0 auto">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:3px solid #0f0e0c">
    <div>
      <div style="font-size:28px;font-weight:700;letter-spacing:-1px">RELIANCE</div>
      <div style="font-size:11px;color:#7a7060;letter-spacing:2px;text-transform:uppercase">Asesores Productores de Seguros</div>
      <div style="font-size:11px;color:#7a7060;margin-top:4px">Av. Orellana E12-113 y San Ignacio, Quito</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:11px;color:#7a7060">Ejecutivo:</div>
      <div style="font-weight:600" id="print-ejecutivo">â€”</div>
      <div style="font-size:11px;color:#7a7060;margin-top:4px" id="print-fecha">â€”</div>
    </div>
  </div>
  <div id="print-content"></div>
  <div style="margin-top:40px;padding-top:16px;border-top:1px solid #d4cbb8;font-size:10px;color:#7a7060;text-align:center">
    Este comparativo es informativo y puede variar segÃºn condiciones especÃ­ficas de cada aseguradora. VÃ¡lido por 30 dÃ­as.
  </div>
</div>

<div class="toast-container" id="toast-container"></div>
</div>

<!-- Capa SharePoint -->
<script src="sp_layer.js"></script>

<!-- LÃ³gica CRM (con SP integrado) -->
<script src="crm.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Indicador de estado SP en topbar
  const ta = document.querySelector('.topbar-actions');
  if(ta){
    const ind = document.createElement('div');
    ind.id = 'sp-status';
    ind.className = 'sp-status syncing';
    ind.textContent = 'âŸ³ Conectando...';
    ind.title = 'Estado de conexiÃ³n SharePoint';
    ta.prepend(ind);
  }
  // BotÃ³n logout en sidebar footer
  const uf = document.querySelector('.sidebar-footer');
  if(uf){
    const btn = document.createElement('button');
    btn.className = 'btn btn-ghost btn-sm';
    btn.style.cssText = 'width:100%;margin-top:6px;color:rgba(255,255,255,.5);border-color:rgba(255,255,255,.1)';
    btn.textContent = 'â¬¡ Cerrar sesiÃ³n';
    btn.onclick = spLogout;
    uf.appendChild(btn);
  }
  // Arrancar â€” MSAL ya estÃ¡ disponible (archivo local)
  bootApp();
});

async function spLogout(){
  if(_msalApp && _account){
    await _msalApp.logoutRedirect({ account: _account });
  }
}
</script>
</body>
</html>
